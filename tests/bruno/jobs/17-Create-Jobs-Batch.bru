meta {
  name: Create Jobs Batch
  type: http
  seq: 23
}

post {
  url: {{baseUrl}}/jobs/batch
  body: json
  auth: none
}

headers {
  Content-Type: application/json
  client_id: {{clientId}}
  client_api_key: {{clientApiKey}}
}

body:json {
  {
    "jobs": [
      {
        "operation": "process",
        "prompts": ["{{promptId1}}"],
        "model": "o3-mini",
        "temperature": 0.7,
        "priority": 100,
        "id": "test-batch-job-1-{{$timestamp}}",
        "requestData": {
          "input": "Hello, this is batch job 1",
          "context": "test context 1"
        },
        "clientReference": {
          "ref": "batch-ref-1"
        }
      },
      {
        "operation": "process",
        "prompts": ["{{promptId1}}"],
        "model": "o3-mini",
        "temperature": 0.8,
        "priority": 200,
        "id": "test-batch-job-2-{{$timestamp}}",
        "requestData": {
          "input": "Hello, this is batch job 2",
          "context": "test context 2"
        },
        "clientReference": {
          "ref": "batch-ref-2"
        }
      },
      {
        "operation": "process",
        "prompts": ["{{promptId1}}"],
        "model": "o3-mini",
        "temperature": 0.6,
        "priority": 150,
        "requestData": {
          "input": "Hello, this is batch job 3 (no custom ID)"
        }
      }
    ]
  }
}

tests {
  test("Status code is 201", function() {
    expect(res.getStatus()).to.equal(201);
  });
  
  test("Response is an array", function() {
    expect(res.getBody()).to.be.an('array');
  });
  
  test("Response contains 3 jobs", function() {
    const jobs = res.getBody();
    expect(jobs.length).to.equal(3);
  });
  
  test("First job has correct properties", function() {
    const jobs = res.getBody();
    const job1 = jobs[0];
    expect(job1.operation).to.equal('process');
    expect(job1.prompts).to.be.an('array');
    expect(job1.prompts.length).to.be.greaterThan(0);
    expect(job1.model).to.equal('o3-mini');
    expect(job1.temperature).to.equal(0.7);
    expect(job1.priority).to.equal(100);
    expect(job1.status).to.equal('PENDING');
    expect(job1).to.have.property('jobId');
    expect(job1).to.have.property('clientId');
    expect(job1).to.have.property('requestData');
    expect(job1.requestData.input).to.equal('Hello, this is batch job 1');
    expect(job1).to.have.property('clientReference');
    expect(job1.clientReference.ref).to.equal('batch-ref-1');
    bru.setVar("createdBatchJobId1", job1.jobId);
  });
  
  test("Second job has correct properties", function() {
    const jobs = res.getBody();
    const job2 = jobs[1];
    expect(job2.operation).to.equal('process');
    expect(job2.temperature).to.equal(0.8);
    expect(job2.priority).to.equal(200);
    expect(job2.status).to.equal('PENDING');
    expect(job2).to.have.property('jobId');
    expect(job2.requestData.input).to.equal('Hello, this is batch job 2');
    expect(job2.clientReference.ref).to.equal('batch-ref-2');
    bru.setVar("createdBatchJobId2", job2.jobId);
  });
  
  test("Third job has correct properties", function() {
    const jobs = res.getBody();
    const job3 = jobs[2];
    expect(job3.operation).to.equal('process');
    expect(job3.temperature).to.equal(0.6);
    expect(job3.priority).to.equal(150);
    expect(job3.status).to.equal('PENDING');
    expect(job3).to.have.property('jobId');
    expect(job3.requestData.input).to.equal('Hello, this is batch job 3 (no custom ID)');
    bru.setVar("createdBatchJobId3", job3.jobId);
  });
  
  test("All jobs have _metadata with createdAt timestamp", function() {
    const jobs = res.getBody();
    jobs.forEach(function(job) {
      expect(job).to.have.property('_metadata');
      expect(job._metadata).to.have.property('createdAt');
    });
  });
  
  test("All jobs belong to the same client", function() {
    const jobs = res.getBody();
    const clientId = jobs[0].clientId;
    jobs.forEach(function(job) {
      expect(job.clientId).to.equal(clientId);
    });
  });
}
