name: Test Pipeline

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      mongo:
        image: mongo:7.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install MongoDB tools
        run: |
          wget -qO - https://www.mongodb.org/static/pgp/server-7.0.asc | sudo apt-key add -
          echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-7.0.list
          sudo apt-get update
          sudo apt-get install -y mongodb-mongosh mongodb-database-tools
      
      - name: Wait for MongoDB to be ready
        run: |
          echo "Waiting for MongoDB to be ready..."
          for i in {1..30}; do
            if mongosh --host localhost --port 27017 --eval "db.runCommand({ ping: 1 })" > /dev/null 2>&1; then
              echo "MongoDB is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
      
      - name: Initialize MongoDB with test data
        run: |
          # Import all test data files
          for file in tests/data/*.json; do
            collection=$(basename "$file" .json)
            echo "Importing $collection from $file..."
            
            # Check if file has actual data (not just empty array)
            if grep -q '"' "$file"; then
              mongoimport --host localhost --port 27017 --db metasync-test --collection "$collection" --file "$file" --jsonArray
            else
              echo "  Skipping $collection (empty array)"
            fi
          done
          
          # Create index on priority field in jobs collection
          echo "Creating index on jobs.priority..."
          mongosh --host localhost --port 27017 metasync-test --eval 'db.jobs.createIndex({ priority: -1 })'
          
          # Verify data was loaded
          echo "Verifying data load..."
          mongosh --host localhost --port 27017 metasync-test --eval 'db.getCollectionNames().forEach(function(col) { print(col + ": " + db[col].countDocuments()); })'
      
      - name: Build Docker image
        run: |
          docker build -t metasync:test .
      
      - name: Start metasync container
        run: |
          # Load environment variables from pipeline-run.env
          set -a
          source tests/pipeline-run.env
          set +a
          
          # Start container with environment variables
          docker run -d \
            --name metasync \
            --network host \
            -e DB_NAME="${DB_NAME}" \
            -e DB_CONNECTION_STRING="${DB_CONNECTION_STRING}" \
            -e API_KEY_PEPPER="${API_KEY_PEPPER}" \
            -e ADMIN_API_KEY="${ADMIN_API_KEY}" \
            -e DOCS_SECRET="${DOCS_SECRET}" \
            -e POLL_INTERVAL="${POLL_INTERVAL}" \
            -e MAX_ITEMS_PER_BATCH="${MAX_ITEMS_PER_BATCH}" \
            -e NUM_LLM_WORKERS="${NUM_LLM_WORKERS}" \
            metasync:test
      
      - name: Wait for metasync to be healthy
        run: |
          echo "Waiting for metasync to be healthy..."
          for i in {1..60}; do
            if curl -f http://localhost:8001/health > /dev/null 2>&1; then
              echo "Metasync is healthy!"
              curl http://localhost:8001/health
              break
            fi
            echo "Waiting... ($i/60)"
            sleep 2
          done
          
          # Final check
          if ! curl -f http://localhost:8001/health > /dev/null 2>&1; then
            echo "Metasync failed to become healthy"
            echo "Container logs:"
            docker logs metasync
            exit 1
          fi
      
      - name: Set up Node.js for Bruno
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Bruno CLI
        run: |
          npm install -g @usebruno/cli
      
      - name: Run Bruno tests
        run: |
          echo "Discovering Bruno test collections..."
          
          # Find all directories with bruno.json (indicates a Bruno collection)
          for collection_dir in tests/bruno/*/; do
            # Remove trailing slash
            collection_dir=${collection_dir%/}
            
            # Get collection name
            collection_name=$(basename "$collection_dir")
            
            # Check if bruno.json exists (confirms it's a collection)
            if [ -f "$collection_dir/bruno.json" ]; then
              echo ""
              echo "=========================================="
              echo "Running tests: $collection_name"
              echo "=========================================="
              
              cd "$collection_dir"
              
              # Run Bruno tests, continue on error so all suites run
              bru run --env local --output ../../.. --reporter-junit "../../../results-${collection_name}.xml" || echo "⚠️  Tests in $collection_name had failures"
              
              # Return to project root
              cd - > /dev/null
            fi
          done
          
          echo ""
          echo "=========================================="
          echo "All test suites completed"
          echo "=========================================="
      
      - name: Show container logs on failure
        if: failure()
        run: |
          echo "=== Metasync Container Logs ==="
          docker logs metasync
          echo ""
          echo "=== MongoDB Connection Test ==="
          mongosh --host localhost --port 27017 metasync-test --eval 'db.getCollectionNames()'
      
      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: |
            results-*.xml
          check_name: Test Results
      
      - name: Cleanup
        if: always()
        run: |
          docker stop metasync || true
          docker rm metasync || true

