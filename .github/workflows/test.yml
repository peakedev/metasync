name: Test Pipeline

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      mongo:
        image: mongo:7.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install MongoDB tools
        run: |
          wget -qO - https://www.mongodb.org/static/pgp/server-7.0.asc | sudo apt-key add -
          echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-7.0.list
          sudo apt-get update
          sudo apt-get install -y mongodb-mongosh mongodb-database-tools
      
      - name: Wait for MongoDB to be ready
        run: |
          echo "Waiting for MongoDB to be ready..."
          for i in {1..30}; do
            if mongosh --host localhost --port 27017 --eval "db.runCommand({ ping: 1 })" > /dev/null 2>&1; then
              echo "MongoDB is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
      
      - name: Initialize MongoDB with test data
        run: |
          # Import all test data files
          for file in tests/data/*.json; do
            collection=$(basename "$file" .json)
            echo "Importing $collection from $file..."
            
            # Check if file has actual data (not just empty array)
            if grep -q '"' "$file"; then
              mongoimport --host localhost --port 27017 --db metasync-test --collection "$collection" --file "$file" --jsonArray
            else
              echo "  Skipping $collection (empty array)"
            fi
          done
          
          # Create index on priority field in jobs collection
          echo "Creating index on jobs.priority..."
          mongosh --host localhost --port 27017 metasync-test --eval 'db.jobs.createIndex({ priority: -1 })'
          
          # Verify data was loaded
          echo "Verifying data load..."
          mongosh --host localhost --port 27017 metasync-test --eval 'db.getCollectionNames().forEach(function(col) { print(col + ": " + db[col].countDocuments()); })'
      
      - name: Build Docker image
        run: |
          docker build -t metasync:test .
      
      - name: Start metasync container
        run: |
          # Start container using env file (with absolute path for reliability)
          docker run -d \
            --name metasync \
            --network host \
            --env-file "${GITHUB_WORKSPACE}/tests/pipeline-run.env" \
            metasync:test
      
      - name: Wait for metasync to be healthy
        run: |
          echo "Waiting for metasync to be healthy..."
          for i in {1..60}; do
            if curl -f http://localhost:8001/health > /dev/null 2>&1; then
              echo "Metasync is healthy!"
              curl http://localhost:8001/health
              break
            fi
            echo "Waiting... ($i/60)"
            sleep 2
          done
          
          # Final check
          if ! curl -f http://localhost:8001/health > /dev/null 2>&1; then
            echo "Metasync failed to become healthy"
            echo "Container logs:"
            docker logs metasync
            exit 1
          fi
      
      - name: Set up Node.js for Bruno
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Bruno CLI
        run: |
          npm install -g @usebruno/cli
      
      - name: Run Bruno tests
        run: |
          echo "Discovering Bruno test collections..."
          
          # Create results directory
          mkdir -p test-results
          
          # Find all directories with bruno.json (indicates a Bruno collection)
          for collection_dir in tests/bruno/*/; do
            # Remove trailing slash
            collection_dir=${collection_dir%/}
            
            # Get collection name
            collection_name=$(basename "$collection_dir")
            
            # Check if bruno.json exists (confirms it's a collection)
            if [ -f "$collection_dir/bruno.json" ]; then
              echo ""
              echo "=========================================="
              echo "Running tests: $collection_name"
              echo "=========================================="
              
              cd "$collection_dir"
              
              # Run Bruno tests with both JUnit and HTML output
              bru run --env local --output ../../.. \
                --reporter-junit "../../../test-results/results-${collection_name}.xml" \
                --reporter-html "../../../test-results/report-${collection_name}.html" || echo "âš ï¸  Tests in $collection_name had failures"
              
              # Return to project root
              cd - > /dev/null
            fi
          done
          
          echo ""
          echo "=========================================="
          echo "All test suites completed"
          echo "=========================================="
      
      - name: Show container logs
        if: always()
        run: |
          echo "=== Metasync Container Logs (Last 100 lines) ==="
          docker logs --tail 100 metasync
          echo ""
          echo "=== MongoDB Connection Test ==="
          mongosh --host localhost --port 27017 metasync-test --eval 'db.getCollectionNames()'
          echo ""
          echo "=== MongoDB Collections Content ==="
          mongosh --host localhost --port 27017 metasync-test --eval 'db.clients.countDocuments()'
          mongosh --host localhost --port 27017 metasync-test --eval 'db.models.countDocuments()'
      
      - name: Generate combined HTML report index
        if: always()
        run: |
          cat > test-results/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Metasync Test Results</title>
            <style>
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
                background: #f5f5f5;
              }
              h1 {
                color: #333;
                border-bottom: 3px solid #4CAF50;
                padding-bottom: 10px;
              }
              .test-suite {
                background: white;
                border-radius: 8px;
                padding: 20px;
                margin: 15px 0;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                transition: transform 0.2s;
              }
              .test-suite:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.15);
              }
              .test-suite h2 {
                margin-top: 0;
                color: #2196F3;
              }
              .test-suite a {
                display: inline-block;
                padding: 10px 20px;
                background: #2196F3;
                color: white;
                text-decoration: none;
                border-radius: 4px;
                transition: background 0.3s;
              }
              .test-suite a:hover {
                background: #1976D2;
              }
              .timestamp {
                color: #666;
                font-size: 0.9em;
              }
            </style>
          </head>
          <body>
            <h1>ðŸ§ª Metasync API Test Results</h1>
            <p class="timestamp">Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')</p>
            <div class="test-suites">
          EOF
          
          # Add links to each test suite report
          for report in test-results/report-*.html; do
            if [ -f "$report" ]; then
              suite_name=$(basename "$report" .html | sed 's/report-//')
              cat >> test-results/index.html << EOF
              <div class="test-suite">
                <h2>ðŸ“‹ ${suite_name}</h2>
                <a href="$(basename "$report")">View Test Report â†’</a>
              </div>
          EOF
            fi
          done
          
          cat >> test-results/index.html << 'EOF'
            </div>
          </body>
          </html>
          EOF
          
          echo "Generated test report index at test-results/index.html"
      
      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: |
            test-results/results-*.xml
          check_name: Test Results
      
      - name: Upload HTML test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports-html
          path: test-results/
          retention-days: 30
      
      - name: Add test report summary
        if: always()
        run: |
          echo "## ðŸ“Š Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Test reports have been generated and are available as artifacts." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Download HTML Reports" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to the [Actions tab](../../actions)" >> $GITHUB_STEP_SUMMARY
          echo "2. Click on this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "3. Scroll down to **Artifacts**" >> $GITHUB_STEP_SUMMARY
          echo "4. Download **test-reports-html**" >> $GITHUB_STEP_SUMMARY
          echo "5. Extract and open \`index.html\` in your browser" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count test suites
          suite_count=$(find test-results -name "report-*.html" 2>/dev/null | wc -l || echo "0")
          echo "### ðŸ“‹ Test Suites Run: ${suite_count}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # List test suites
          for report in test-results/report-*.html; do
            if [ -f "$report" ]; then
              suite_name=$(basename "$report" .html | sed 's/report-//')
              echo "- âœ… ${suite_name}" >> $GITHUB_STEP_SUMMARY
            fi
          done
      
      - name: Cleanup
        if: always()
        run: |
          docker stop metasync || true
          docker rm metasync || true

